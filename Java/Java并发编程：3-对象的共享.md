----------
# 线程安全性
# 原子性
# 加锁机制
# 用锁来保护状态
# 活跃性与性能
----------
# 可见性
synchronized 同步代码块或者同步方法可以确保以原子的方式执行操作  
synchronized不止用于实现原子性或者确定“临界区”，同时还可以确保内存可见性  
我们不仅希望防止某个线程正在使用对象状态而另一个线程在同时修改该状态，而且希望确保当一个线程修改了对象状态后，其他线程能够看到发生的状态变化。如果没有同步，那么这种情况就无法实现，你可以通过显示的同步或者类库中内置的同步来保证对象被安全的发布。  

![4-指令重排线程不安全.jpg](./img/4-指令重排线程不安全.jpg)
上例线程可能会持续循环下去，因为读线程永远抢不到CPU执行，看不到ready的值  
还有一种可能是会输出0，看到这里一定很好奇，读线程如果能看到ready为true说明，number=42已经执行了。
难道说number=42 在 ready=true 之前执行？  
确实是改变了，这种现象被称为“重排序”，这看上去似乎是一种失败的设计，但事实上并非如此，JVM通过这种方式充分地利用了现代多核处理器的强大性能。例如，在缺少同步的情况下，Java内存模型允许编译器对操作顺序进行重排序，并将数值缓存在寄存器中，它还允许CPU对操作顺序进行重排序，并将数值缓存在处理器的特定缓存中。

## 失效数据 
对写加锁，读未加锁，例如最后一件商品，有人已经下单了，但写比较慢，读比较快，你一读发现还有一件，但你一写却告诉你没了。


## 非原子的64位操作
Java内存模型要求，变量的读取和写入都必须是原子操作  
但是对于非volatile类型的64位数值变量double和long，JVM允许将64位的操作分解为32位的操作  
如果对该变量的读操作和写操作在不同线程执行，可能读到某个值的高32位和另一个值的低32位  
因此多线程中使用共享且可变的long和double的变量也是不安全的，除非用volatile声明他们，或者加锁

## 加锁与可见性
加锁的含义不仅仅局限于互斥行为，还包括可见性，为了确保所有线程都能看到共享变量的最新值，所有执行读写操作的线程必须在同一个锁上同步。

## Volatile变量
内存可见性，比synchronized关键字更轻量级的同步机制，变量声明volatile后，编译器与运行时都会注意到这个变量是共享的  因此不会将该变量上的操作与其他内存操作一起重排序，volatile变量不会被缓存在寄存器和这其他处理器不可见的地方，因此每次读取的总是返回的最新写入的值，可以这样理解，之前线程都会从内存堆中取一份值然后缓存到线程内部，之后的操作都是基于线程内部的值，结束操作后将结果覆盖内存中之前读取的那个变量，这就导致一个线程在内部修改那个变量时，例如之前说的下单，这个线程其实就是最后一个买到的人，在线程内部修改了还没写入内存，所以内存中还是剩最后一件的，此时你去读的话还有，但写的时候却没了，加了volatile后，线程就不会缓存内存堆中的值到线程内部，而是直接修改内存中的值。

当且仅当满足以下所有条件时，才应该使用volatile变量
- 对变量的写入操作不依赖变量的当前值，或者确保只有一个线程更新变量的值
- 该变量不会与其他状态变量一起纳入不变性条件中
- 在访问变量时不需要加锁


# 发布与逸出
使用工厂方法来防止this引用在构造过程中逸出  
只有当构造函数返回时，this引用才应该从线程中逸出，构造函数可以将this引用保存到某个地方，只要其他线程不会在构造函数完成前使用它
```java
public static SafeListener newInstance(EventSource source){
    SafeListener safe=new SafeListener();
    source.registerListener(safe.listener);
    return safe;
}
```

# 线程封闭
通过不共享数据的方式来避免同步，相当于仅在单线程内访问数据，这种技术被称为线程封闭  
JDBC的Connection对象就使用的这种技术，Java语言及核心库提供了一些机制来帮助维持线程封闭性，例如局部变量和ThreadLocal类

# 不变性
被final 修饰的对象，不可变的是指向对象的引用，对象本身是可以被改变的。
当满足一下条件时，对象才是不可变的：
对象创建以后其状态就不能修改  
对象的所有域都是final类型  
对象是正确创建的(在对象的创建期间，this引用没有逸出)

final

# 安全发布
https://blog.51cto.com/zero01/2300908

----- 对象的组合

# 设计线程安全的类

